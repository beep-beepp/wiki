# ZGC
ZGC는 Z Garbage Collector로, scalable한 low latency garbage collector이다.

## 개요
ZGC는 JDK 11에서 experimental feature로 처음 도입되었으며,
<br>JDK 15에서 production ready 단계로 선언되었다.
<br>그리고 JDK 21에서는 generation을 지원하도록 reimplemented(재구현)되었다.

## 한눈에 보는 특징
- Concurrent
- Region-based
- Compacting
- NUMA-aware
- Using colored pointers
- Using load barriers
- Using store barriers

ZGC의 핵심은 concurrent garbage collector라는 점이다.
<br>즉, 모든 무거운 작업이 Java 스레드가 계속 실행되는 동안 수행된다는 뜻이다.
<br>이로 인해 garbage collection이 애플리케이션의 response time에 미치는 영향을 크게 제한한다.

## 특징
ZGC는 모든 비용이 큰 작업을 Concurrent로 수행하며, 애플리케이션 스레드의 실행을 1ms 이상 멈추지 않는다.
<br>따라서 low latency가 요구되는 애플리케이션에 적합하다.
<br>ZGC의 pause time은 사용중인 힙 크기와 무관하며, 수백 MB에서 최대 16TB의 힙 크기까지 안정적으로 동작한다.

ZGC는 자동으로 적응(adaptive) 하도록 설계되었으며, 수동 설정이 거의 필요하지 않도록 만들어졌다.
<br>Java 프로그램이 실행되는 동안, ZGC는 workload에 따라 동적으로 적응(dynamically adapts)하며 다음을 수행한다.
- Resizing Generation
- GC 스레드 수 확장
- 객체 승격(tenuring) 임계값 조정 (adjusting tenuring thresholds)

주요 튜닝 요소는 최대 힙 크기를 늘리는 것이다.

ZGC에는 두 가지 버전이 존재한다:
1. 새로운 Generational 버전
2. 이전에 Non-generational 버전

Non-generational ZGC는 Generation을 활용하지 않는 구버전의 ZGC로, 런타임 특성을 최적화하는 데 한계가 있다.
<br>따라서 사용자들은 새로운 Generational ZGC로 전환하는 것을 권장한다.

## Setting the Heap Size
ZGC에서 가장 중요한 튜닝 옵션은 최대 힙 크기를 설정하는 것이다.
이 값은 cli 옵션 `-Xmx` 로 지정할 수 있다.

ZGC는 Concurrent garbage collector이므로, 힙이 애플리케이션의 live-set(현재 살아있는 객체 집합)을 수용할 수 있어야 하며,
<br>동시에 GC가 실행되는 동안에도 새로운 객체 할당을 처리할 수 있을 만큼의 headroom(여유 공간)이 있어야 한다.

필요한 headroom의 크기는 애플리케이션의 allocation rate(객체 할당 속도)와 live-set의 크기에 크게 의존한다.
<br>일반적으로, ZGC에 메모리를 더 많이 할당할수록 성능은 더 좋아진다.
<br>하지만 동시에 불필요한 메모리 낭비는 바람직하지 않으므로, 메모리 사용량과 GC 실행 빈도 간의 균형을 찾는 것이 중요하다.

ZGC에는 힙 크기와 관련된 또 다른 cli 옵션인 `-XX:SoftMaxHeapSize`가 있다.
<br>이 옵션은 Java 힙이 얼마나 크게 성장할 수 있는지를 제한하는 "soft limit(소프트 한계)"를 설정하는데 사용된다.

ZGC는 이 한계를 넘지 않으려고 노력하지만, 필요할 경우 최대 힙 크기(`-Xmx`) 까지는 한시적으로 초과하여 성장할 수 있다.
<br>ZGC는 GC가 메모리를 회수하기를 기다리느라 Java 애플리케이션이 멈추는(stalling) 상황을 방지할 필요가 있을떄만, soft limit을 초과하려 메모리를 사용한다.

예를 들어, cli 옵션이 다음과 같을 경우:
```text
-Xmx5g -XX:SoftMaxHeapSize=4g
```
ZGC는 자신의 휴리스틱(heuristics)을 적용할 때 4GB를 한계로 사용하지만, 
<br>힙 크기를 4GB 이하로 유지할 수 없는 경우에는 일시적으로 최대 5GB까지 사용할 수 있다.

## Returning Unused Memory to the Operating System

기본적으로 ZGC는 사용되지 않는 메모리를 uncommit(해제)하여 운영체제에 반환한다.
<br>이 기능은 memory footprint(메모리 사용량) 이 중요한 애플리케이션이나 환경에서 유용하지만,
<br>Java 스레드의 latency에 부정적인 영향을 줄 수 있다.

이 기능은 cli 옵션 `-XX:-ZUncommit`으로 disable(비활성화)할 수 있다.

또한, 힙 크기가 최소 힙 크기(-Xms)보다 작아지지 않도록 메모리를 uncommit하지 않는다.
<br>즉, 최소 힙 크기(-Xms)가 최대 힙 크기(-Xmx)와 동일하게 설정된 경우,
<br>이 기능은 암묵적으로 disable된다.

cli 옵션 `-XX:ZUncommitDelay=<seconds>` 를 사용하여 uncommit delay(메모리 해제 지연 시간)를 설정할 수 있다.
<br>기본값은 300초(5분)이다.
<br>이 delay는 메모리가 사용되지 않은 상태로 얼마나 오래 있었을 때 해제되어 운영체제로 반환될 수 있는지를 지정한다.

## 참고
### [Oracle](https://docs.oracle.com/en/java/javase/21/gctuning/z-garbage-collector.html#GUID-FD855EE7-9ED3-46BF-8EA5-A73EB5096DDB)
### [Open JDK wiki](https://wiki.openjdk.org/display/zgc/Main)

