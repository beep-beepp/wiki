# DB FlashBack

## Flashback 이란?

- 별도의 백업/복구 없이, SCN 또는 시점을 기준으로 과거 상태를 조회/되돌리는 Oracle의 시계 되감기 기능 세트
- Oracle은 이걸 통째로 Oracle Flashback Technology 라고 부름
- 사람 실수, 앱 버그 같은 논리적 오류(Logical Error) 복구에 특화된 기능
- 변경이 일어날 때 마다 Snapshot을 찍어두고, 필요 시 해당 시점으로 돌아감
- 대상: **변경된 블록의 이전 버전**
- 저장 위치: **FRA(Flash Recovery Area)**

## Flashback이 동작하는 내부 원리 (Oracle 기준)

1. Flashback Database 활성화 상태에서 DB의 변경이 발생할 때마다
2. Oracle은 **변경되는 블록의 이전 버전(previous image)** 을 Flashback Log에 저장
3. SCN 또는 시점으로 Flashback 요청이 들어오면
4. Flashback Log에서 해당 시점 이전의 블록 버전을 찾아 보여줌

## 용어 정리

FRA = Flashback Log를 담는 저장소

Flashback Log = 변경 전 블록 이미지

SCN = 언제로 돌아갈지 기준

UNDO = 조회용 과거 버전

Flashback Log = 복구용 과거 버전

## Flashback 종류

**과거 데이터를 조회하고 싶으면 → UNDO(Flashback Query / Versions Query)**

**DB 전체를 과거로 되돌리고 싶으면 → Flashback Log(FRA) 기반 (Flashback Table, Flashback Database)**


사용자가 UNDO를 쓰는지, FDA를 쓰는지 구분하지 않게 만든 것.



## 그대를 살려줄 Flashback Query 

### 시점 기반
- 원하는 시간은 DBA 지정, Default 3hour
- 과거 시점의 데이터 조회만
- UNDO 기반
```
  SELECT *
  FROM 테이블명 AS OF TIMESTAMP (SYSDATE - INTERVAL '원하는 시간' HOUR)
  WHERE 조건;
```
```
SELECT *
FROM 테이블명 AS OF TIMESTAMP( SYSDATE-1/24 )
where 조건;
```

### SCN 기반
```
SELECT *
FROM 테이블명 AS OF SCN 1234567
WHERE 조건;
```
### Version Query (변경 이력 조회)
```
SELECT versions_starttime,
       versions_endtime,
       versions_xid,
       versions_operation,
       테이블.*
  FROM 테이블
  VERSIONS BETWEEN TIMESTAMP
    SYSTIMESTAMP - INTERVAL '원하는 시간' HOUR AND SYSTIMESTAMP
 WHERE [조건컬럼] = [조건값];
```