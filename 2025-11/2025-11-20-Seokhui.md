# Saga Pattern

### ê¸°ë³¸ ê°œë…

**Saga = ì—¬ëŸ¬ ê°œì˜ ì‘ì€ íŠ¸ëœì­ì…˜ë“¤ì„ ì—°ê²°í•´ì„œ í•˜ë‚˜ì˜ í° ì‘ì—…ì„ ì™„ì„±í•˜ëŠ” íŒ¨í„´**

### ì™œ í•„ìš”í•œê°€?

```java
ì „í†µì ì¸ ë°©ì‹ (ACID íŠ¸ëœì­ì…˜):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  í•˜ë‚˜ì˜ í° íŠ¸ëœì­ì…˜              â”‚
â”‚  â”œâ”€ ì‘ì—… 1                      â”‚
â”‚  â”œâ”€ ì‘ì—… 2                      â”‚
â”‚  â”œâ”€ ì‘ì—… 3                      â”‚
â”‚  â””â”€ ì‘ì—… 4                      â”‚
â”‚                                 â”‚
â”‚  ì „ì²´ ì„±ê³µ â†’ COMMIT             â”‚
â”‚  í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨ â†’ ì „ì²´ ROLLBACK   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Saga Pattern:
â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
â”‚ T1  â”‚â†’ â”‚ T2  â”‚â†’ â”‚ T3  â”‚â†’ â”‚ T4  â”‚
â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
  â†“        â†“        â†“        â†“
ì»¤ë°‹     ì»¤ë°‹     ì»¤ë°‹     ì»¤ë°‹
  
ê° ì‘ì—…ì´ ë…ë¦½ì ìœ¼ë¡œ ì»¤ë°‹!
ì‹¤íŒ¨ ì‹œ â†’ ë³´ìƒ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë˜ëŒë¦¼
```

**ë¬¸ì œ ìƒí™©:**

```java
*// ì „í†µì ì¸ ëª¨ë†€ë¦¬ì‹ ë°©ì‹*
@Transactional
public Order createOrder(OrderRequest request) {
    *// í•˜ë‚˜ì˜ DB, í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜*
    Order order = orderRepository.save(new Order(request));
    productRepository.decreaseStock(request.getProductId());
    userRepository.decreasePoint(request.getUserId());
    
    *// ëª¨ë‘ ê°™ì€ DB, ê°™ì€ íŠ¸ëœì­ì…˜// ì‹¤íŒ¨í•˜ë©´ ì „ì²´ ë¡¤ë°± â†’ ê°„ë‹¨!*
}
```

**ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½:**

```java
*// ë¬¸ì œ: ì„œë¹„ìŠ¤ë“¤ì´ ë¶„ë¦¬ë˜ì–´ ìˆìŒ!*
public Order createOrder(OrderRequest request) {
    
    *// ì£¼ë¬¸ ì„œë¹„ìŠ¤ (DB-A)*
    Order order = orderService.createOrder(request);
    
    *// ì¬ê³  ì„œë¹„ìŠ¤ (DB-B, ë‹¤ë¥¸ ì„œë²„)*
    inventoryService.decreaseStock(request.getProductId());
    
    *// ê²°ì œ ì„œë¹„ìŠ¤ (DB-C, ë˜ ë‹¤ë¥¸ ì„œë²„)*
    paymentService.processPayment(order);
    
    *// ë°°ì†¡ ì„œë¹„ìŠ¤ (DB-D, ë˜ ë‹¤ë¥¸ ì„œë²„)*
    shippingService.createShipment(order);
    
    *// ë¬¸ì œ:// 1. ê° ì„œë¹„ìŠ¤ê°€ ë‹¤ë¥¸ DB ì‚¬ìš©// 2. ë¶„ì‚° íŠ¸ëœì­ì…˜ (2PC)ì€ ë„ˆë¬´ ë³µì¡í•˜ê³  ëŠë¦¼// 3. ë°°ì†¡ì—ì„œ ì‹¤íŒ¨í•˜ë©´? ì£¼ë¬¸, ì¬ê³ , ê²°ì œëŠ” ì´ë¯¸ ì»¤ë°‹ë¨!*
    
    *// â†’ Saga Patternìœ¼ë¡œ í•´ê²°!*
}
```


# Saga Patternì˜ ë‘ ê°€ì§€ êµ¬í˜„ ë°©ì‹

## Choreography  ë°©ì‹

- **ê° ì„œë¹„ìŠ¤ê°€ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ê³ , ë‹¤ë¥¸ ì„œë¹„ìŠ¤ê°€ ì´ë¥¼ êµ¬ë…í•´ì„œ ë°˜ì‘**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì£¼ë¬¸ ì„œë¹„ìŠ¤  â”‚ ì£¼ë¬¸ ìƒì„± ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ OrderCreatedEvent
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì¬ê³  ì„œë¹„ìŠ¤  â”‚ ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ ì¬ê³  ì°¨ê°
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ StockDecreasedEvent
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ê²°ì œ ì„œë¹„ìŠ¤  â”‚ ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ ê²°ì œ ì²˜ë¦¬
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ PaymentProcessedEvent
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë°°ì†¡ ì„œë¹„ìŠ¤  â”‚ ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ ë°°ì†¡ ìƒì„±
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`
```
**ì½”ë“œ ì˜ˆì‹œ:**
``` java
*// ì£¼ë¬¸ ì„œë¹„ìŠ¤*
@Service
public class OrderService {
    
    private final ApplicationEventPublisher eventPublisher;
    
    public Mono<Order> createOrder(OrderRequest request) {
        return orderRepository.save(new Order(request))
            .doOnSuccess(order -> {
                *// ì£¼ë¬¸ ìƒì„± ì´ë²¤íŠ¸ ë°œí–‰*
                OrderCreatedEvent event = new OrderCreatedEvent(
                    order.getId(),
                    order.getProductId(),
                    order.getQuantity(),
                    order.getAmount()
                );
                eventPublisher.publishEvent(event);
                System.out.println("ì£¼ë¬¸ ìƒì„± ì´ë²¤íŠ¸ ë°œí–‰: " + order.getId());
            });
    }
    
    *// ì¬ê³  ì°¨ê° ì‹¤íŒ¨ ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ ë³´ìƒ*
    @EventListener
    public void handleStockDecreaseFailed(StockDecreaseFailedEvent event) {
        System.out.println("ì¬ê³  ì°¨ê° ì‹¤íŒ¨! ì£¼ë¬¸ ì·¨ì†Œ: " + event.getOrderId());
        
        orderRepository.findById(event.getOrderId())
            .flatMap(order -> {
                order.cancel();
                return orderRepository.save(order);
            })
            .subscribe();
    }
}

*// ì¬ê³  ì„œë¹„ìŠ¤*
@Service
public class InventoryService {
    
    private final ApplicationEventPublisher eventPublisher;
    
    @EventListener
    public void handleOrderCreated(OrderCreatedEvent event) {
        System.out.println("ì£¼ë¬¸ ìƒì„± ì´ë²¤íŠ¸ ìˆ˜ì‹ : " + event.getOrderId());
        
        productRepository.findById(event.getProductId())
            .flatMap(product -> {
                if (product.getStock() < event.getQuantity()) {
                    *// ì¬ê³  ë¶€ì¡± â†’ ì‹¤íŒ¨ ì´ë²¤íŠ¸ ë°œí–‰*
                    StockDecreaseFailedEvent failEvent = 
                        new StockDecreaseFailedEvent(event.getOrderId());
                    eventPublisher.publishEvent(failEvent);
                    
                    return Mono.error(new InsufficientStockException());
                }
                
                *// ì¬ê³  ì°¨ê°*
                product.decreaseStock(event.getQuantity());
                return productRepository.save(product);
            })
            .doOnSuccess(product -> {
                *// ì¬ê³  ì°¨ê° ì„±ê³µ ì´ë²¤íŠ¸ ë°œí–‰*
                StockDecreasedEvent successEvent = new StockDecreasedEvent(
                    event.getOrderId(),
                    event.getProductId(),
                    event.getQuantity()
                );
                eventPublisher.publishEvent(successEvent);
                System.out.println("ì¬ê³  ì°¨ê° ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰");
            })
            .subscribe();
    }
    
    *// ê²°ì œ ì‹¤íŒ¨ ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ ë³´ìƒ*
    @EventListener
    public void handlePaymentFailed(PaymentFailedEvent event) {
        System.out.println("ê²°ì œ ì‹¤íŒ¨! ì¬ê³  ë³µêµ¬: " + event.getOrderId());
        
        productRepository.findById(event.getProductId())
            .flatMap(product -> {
                product.increaseStock(event.getQuantity());
                return productRepository.save(product);
            })
            .subscribe();
    }
}

*// ê²°ì œ ì„œë¹„ìŠ¤*
@Service
public class PaymentService {
    
    private final ApplicationEventPublisher eventPublisher;
    
    @EventListener
    public void handleStockDecreased(StockDecreasedEvent event) {
        System.out.println("ì¬ê³  ì°¨ê° ì´ë²¤íŠ¸ ìˆ˜ì‹ : " + event.getOrderId());
        
        *// ê²°ì œ ì²˜ë¦¬*
        paymentClient.processPayment(event.getOrderId())
            .doOnSuccess(payment -> {
                *// ê²°ì œ ì„±ê³µ ì´ë²¤íŠ¸ ë°œí–‰*
                PaymentProcessedEvent successEvent = new PaymentProcessedEvent(
                    event.getOrderId(),
                    payment.getId()
                );
                eventPublisher.publishEvent(successEvent);
                System.out.println("ê²°ì œ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰");
            })
            .doOnError(error -> {
                *// ê²°ì œ ì‹¤íŒ¨ ì´ë²¤íŠ¸ ë°œí–‰*
                PaymentFailedEvent failEvent = new PaymentFailedEvent(
                    event.getOrderId(),
                    event.getProductId(),
                    event.getQuantity()
                );
                eventPublisher.publishEvent(failEvent);
                System.out.println("ê²°ì œ ì‹¤íŒ¨ ì´ë²¤íŠ¸ ë°œí–‰");
            })
            .subscribe();
    }
}
```

**ì‹¤í–‰ ê³¼ì •:**
```
[ì •ìƒ ì¼€ì´ìŠ¤]
1. ì£¼ë¬¸ ì„œë¹„ìŠ¤: ì£¼ë¬¸ ìƒì„± â†’ OrderCreatedEvent ë°œí–‰
2. ì¬ê³  ì„œë¹„ìŠ¤: ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ ì¬ê³  ì°¨ê° â†’ StockDecreasedEvent ë°œí–‰
3. ê²°ì œ ì„œë¹„ìŠ¤: ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ ê²°ì œ ì²˜ë¦¬ â†’ PaymentProcessedEvent ë°œí–‰
4. ë°°ì†¡ ì„œë¹„ìŠ¤: ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ ë°°ì†¡ ìƒì„±

[ì‹¤íŒ¨ ì¼€ì´ìŠ¤]
1. ì£¼ë¬¸ ì„œë¹„ìŠ¤: ì£¼ë¬¸ ìƒì„± â†’ OrderCreatedEvent ë°œí–‰
2. ì¬ê³  ì„œë¹„ìŠ¤: ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ ì¬ê³  ì°¨ê° â†’ StockDecreasedEvent ë°œí–‰
3. ê²°ì œ ì„œë¹„ìŠ¤: ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ ê²°ì œ ì‹¤íŒ¨! âŒ â†’ PaymentFailedEvent ë°œí–‰
4. ì¬ê³  ì„œë¹„ìŠ¤: ì‹¤íŒ¨ ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ ì¬ê³  ë³µêµ¬ (ë³´ìƒ)
5. ì£¼ë¬¸ ì„œë¹„ìŠ¤: ì‹¤íŒ¨ ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ ì£¼ë¬¸ ì·¨ì†Œ (ë³´ìƒ)
```

**ì¥ì :**
- âœ… ì¤‘ì•™ ì¡°ì •ì ì—†ìŒ (ëŠìŠ¨í•œ ê²°í•©)
- âœ… ì„œë¹„ìŠ¤ ì¶”ê°€/ì œê±° ì‰¬ì›€
- âœ… í™•ì¥ì„± ì¢‹ìŒ

**ë‹¨ì :**
- âŒ ì „ì²´ íë¦„ íŒŒì•… ì–´ë ¤ì›€ (ë””ë²„ê¹… í˜ë“¦)
- âŒ ìˆœí™˜ ì˜ì¡´ì„± ë°œìƒ ê°€ëŠ¥
- âŒ ë³´ìƒ ë¡œì§ì´ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆìŒ`


## Orchestration ë°©ì‹

- **ì¤‘ì•™ ì¡°ì •ì(Orchestrator)ê°€ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ í˜¸ì¶œí•˜ê³  ê´€ë¦¬**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Saga Manager   â”‚ â† ì¤‘ì•™ ì¡°ì •ì
â”‚  (Orchestrator) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
    â†“    â†“    â†“    â†“    â†“
  â”Œâ”€â”€â”€â”â”Œâ”€â”€â”€â”â”Œâ”€â”€â”€â”â”Œâ”€â”€â”€â”â”Œâ”€â”€â”€â”
  â”‚ì£¼ë¬¸â”‚â”‚ì¬ê³ â”‚â”‚ê²°ì œâ”‚â”‚ë°°ì†¡â”‚â”‚ì•Œë¦¼â”‚
  â””â”€â”€â”€â”˜â””â”€â”€â”€â”˜â””â”€â”€â”€â”˜â””â”€â”€â”€â”˜â””â”€â”€â”€â”˜`
```

**ì½”ë“œ ì˜ˆì‹œ:**

```java

// Saga ë‹¨ê³„ ì •ì˜*
public enum SagaStep {
    CREATE_ORDER,
    DECREASE_STOCK,
    PROCESS_PAYMENT,
    CREATE_SHIPMENT,
    SEND_NOTIFICATION
}

*// Saga ìƒíƒœ*
public class SagaState {
    private String sagaId;
    private String orderId;
    private OrderRequest request;
    private SagaStep currentStep;
    private SagaStatus status;
    private Map<SagaStep, StepResult> completedSteps;
    
    *// ì„±ê³µí•œ ë‹¨ê³„ ê¸°ë¡*
    public void recordSuccess(SagaStep step, Object result) {
        completedSteps.put(step, new StepResult(true, result, null));
    }
    
    *// ì‹¤íŒ¨í•œ ë‹¨ê³„ ê¸°ë¡*
    public void recordFailure(SagaStep step, Throwable error) {
        completedSteps.put(step, new StepResult(false, null, error));
    }
    
    *// ë³´ìƒì´ í•„ìš”í•œ ë‹¨ê³„ë“¤ ë°˜í™˜*
    public List<SagaStep> getStepsToCompensate() {
        return completedSteps.entrySet().stream()
            .filter(entry -> entry.getValue().isSuccess())
            .map(Map.Entry::getKey)
            .sorted(Comparator.reverseOrder()) *// ì—­ìˆœìœ¼ë¡œ*
            .collect(Collectors.toList());
    }
}

*// Saga Orchestrator*
@Service
public class OrderSagaOrchestrator {
    
    private final OrderService orderService;
    private final InventoryService inventoryService;
    private final PaymentService paymentService;
    private final ShippingService shippingService;
    private final NotificationService notificationService;
    
    public Mono<SagaResult> executeSaga(OrderRequest request) {
        
        String sagaId = UUID.randomUUID().toString();
        SagaState state = new SagaState(sagaId, request);
        
        System.out.println("=== Saga ì‹œì‘: " + sagaId + " ===");
        
        return Mono.just(state)
            *// 1ë‹¨ê³„: ì£¼ë¬¸ ìƒì„±*
            .flatMap(s -> executeStep(
                s,
                SagaStep.CREATE_ORDER,
                () -> orderService.createOrder(request),
                order -> {
                    s.setOrderId(order.getId());
                    s.recordSuccess(SagaStep.CREATE_ORDER, order);
                    System.out.println("âœ… ì£¼ë¬¸ ìƒì„± ì™„ë£Œ: " + order.getId());
                }
            ))
            
            *// 2ë‹¨ê³„: ì¬ê³  ì°¨ê°*
            .flatMap(s -> executeStep(
                s,
                SagaStep.DECREASE_STOCK,
                () -> inventoryService.decreaseStock(
                    request.getProductId(), 
                    request.getQuantity()
                ),
                product -> {
                    s.recordSuccess(SagaStep.DECREASE_STOCK, product);
                    System.out.println("âœ… ì¬ê³  ì°¨ê° ì™„ë£Œ");
                }
            ))
            
            *// 3ë‹¨ê³„: ê²°ì œ ì²˜ë¦¬*
            .flatMap(s -> executeStep(
                s,
                SagaStep.PROCESS_PAYMENT,
                () -> paymentService.processPayment(
                    new PaymentRequest(s.getOrderId(), request.getAmount())
                ),
                payment -> {
                    s.recordSuccess(SagaStep.PROCESS_PAYMENT, payment);
                    System.out.println("âœ… ê²°ì œ ì™„ë£Œ: " + payment.getId());
                }
            ))
            
            *// 4ë‹¨ê³„: ë°°ì†¡ ìƒì„±*
            .flatMap(s -> executeStep(
                s,
                SagaStep.CREATE_SHIPMENT,
                () -> shippingService.createShipment(s.getOrderId()),
                shipment -> {
                    s.recordSuccess(SagaStep.CREATE_SHIPMENT, shipment);
                    System.out.println("âœ… ë°°ì†¡ ìƒì„± ì™„ë£Œ: " + shipment.getId());
                }
            ))
            
            *// 5ë‹¨ê³„: ì•Œë¦¼ ì „ì†¡*
            .flatMap(s -> executeStep(
                s,
                SagaStep.SEND_NOTIFICATION,
                () -> notificationService.sendOrderConfirmation(s.getOrderId()),
                notification -> {
                    s.recordSuccess(SagaStep.SEND_NOTIFICATION, notification);
                    System.out.println("âœ… ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ");
                }
            ))
            
            *// ì„±ê³µ*
            .map(s -> {
                s.setStatus(SagaStatus.COMPLETED);
                System.out.println("=== Saga ì™„ë£Œ: " + sagaId + " ===");
                return SagaResult.success(s);
            })
            
            *// ì‹¤íŒ¨ ì‹œ ë³´ìƒ*
            .onErrorResume(error -> {
                System.err.println("=== Saga ì‹¤íŒ¨: " + sagaId + " ===");
                System.err.println("ì—ëŸ¬: " + error.getMessage());
                
                return compensate(state, error)
                    .then(Mono.just(SagaResult.failure(state, error)));
            });
    }
    
    private <T> Mono<SagaState> executeStep(
            SagaState state,
            SagaStep step,
            Supplier<Mono<T>> action,
            Consumer<T> onSuccess) {
        
        state.setCurrentStep(step);
        
        return action.get()
            .doOnSuccess(result -> {
                onSuccess.accept(result);
            })
            .doOnError(error -> {
                state.recordFailure(step, error);
                System.err.println("âŒ " + step + " ì‹¤íŒ¨: " + error.getMessage());
            })
            .thenReturn(state);
    }
    
    private Mono<Void> compensate(SagaState state, Throwable originalError) {
        
        System.out.println("=== ë³´ìƒ íŠ¸ëœì­ì…˜ ì‹œì‘ ===");
        
        List<SagaStep> stepsToCompensate = state.getStepsToCompensate();
        
        *// ì„±ê³µí•œ ë‹¨ê³„ë“¤ì„ ì—­ìˆœìœ¼ë¡œ ë³´ìƒ*
        List<Mono<Void>> compensations = new ArrayList<>();
        
        for (SagaStep step : stepsToCompensate) {
            Mono<Void> compensation = switch (step) {
                case CREATE_ORDER -> {
                    System.out.println("ğŸ”„ ì£¼ë¬¸ ì·¨ì†Œ ì¤‘...");
                    yield orderService.cancelOrder(state.getOrderId())
                        .doOnSuccess(v -> System.out.println("âœ… ì£¼ë¬¸ ì·¨ì†Œ ì™„ë£Œ"));
                }
                case DECREASE_STOCK -> {
                    System.out.println("ğŸ”„ ì¬ê³  ë³µêµ¬ ì¤‘...");
                    yield inventoryService.restoreStock(
                        state.getRequest().getProductId(),
                        state.getRequest().getQuantity()
                    ).doOnSuccess(v -> System.out.println("âœ… ì¬ê³  ë³µêµ¬ ì™„ë£Œ"));
                }
                case PROCESS_PAYMENT -> {
                    System.out.println("ğŸ”„ ê²°ì œ ì·¨ì†Œ ì¤‘...");
                    StepResult paymentResult = state.getCompletedSteps().get(SagaStep.PROCESS_PAYMENT);
                    Payment payment = (Payment) paymentResult.getResult();
                    yield paymentService.refundPayment(payment.getId())
                        .doOnSuccess(v -> System.out.println("âœ… ê²°ì œ ì·¨ì†Œ ì™„ë£Œ"));
                }
                case CREATE_SHIPMENT -> {
                    System.out.println("ğŸ”„ ë°°ì†¡ ì·¨ì†Œ ì¤‘...");
                    StepResult shipmentResult = state.getCompletedSteps().get(SagaStep.CREATE_SHIPMENT);
                    Shipment shipment = (Shipment) shipmentResult.getResult();
                    yield shippingService.cancelShipment(shipment.getId())
                        .doOnSuccess(v -> System.out.println("âœ… ë°°ì†¡ ì·¨ì†Œ ì™„ë£Œ"));
                }
                default -> Mono.empty();
            };
            
            compensations.add(compensation);
        }
        
        *// ëª¨ë“  ë³´ìƒ ì‘ì—… ì‹¤í–‰*
        return Mono.when(compensations)
            .doOnSuccess(v -> {
                System.out.println("=== ë³´ìƒ íŠ¸ëœì­ì…˜ ì™„ë£Œ ===");
                state.setStatus(SagaStatus.COMPENSATED);
            })
            .doOnError(e -> {
                System.err.println("=== ë³´ìƒ íŠ¸ëœì­ì…˜ ì‹¤íŒ¨ ===");
                System.err.println("ì‹¬ê°í•œ ë¬¸ì œ ë°œìƒ! ìˆ˜ë™ ê°œì… í•„ìš”!");
                state.setStatus(SagaStatus.FAILED);
                *// ì•Œë¦¼ ì „ì†¡, ë¡œê·¸ ê¸°ë¡ ë“±*
            })
            .then();
    }
}
```

**ì‹¤í–‰ ë¡œê·¸ (ì •ìƒ ì¼€ì´ìŠ¤):**
```
=== Saga ì‹œì‘: saga-12345 ===
âœ… ì£¼ë¬¸ ìƒì„± ì™„ë£Œ: ORDER-001
âœ… ì¬ê³  ì°¨ê° ì™„ë£Œ
âœ… ê²°ì œ ì™„ë£Œ: PAYMENT-001
âœ… ë°°ì†¡ ìƒì„± ì™„ë£Œ: SHIPMENT-001
âœ… ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ
=== Saga ì™„ë£Œ: saga-12345 ===
```

**ì‹¤í–‰ ë¡œê·¸ (ì‹¤íŒ¨ + ë³´ìƒ ì¼€ì´ìŠ¤):**
```
=== Saga ì‹œì‘: saga-12345 ===
âœ… ì£¼ë¬¸ ìƒì„± ì™„ë£Œ: ORDER-001
âœ… ì¬ê³  ì°¨ê° ì™„ë£Œ
âŒ PROCESS_PAYMENT ì‹¤íŒ¨: Card declined

=== Saga ì‹¤íŒ¨: saga-12345 ===
ì—ëŸ¬: Card declined

=== ë³´ìƒ íŠ¸ëœì­ì…˜ ì‹œì‘ ===
ğŸ”„ ì¬ê³  ë³µêµ¬ ì¤‘...
âœ… ì¬ê³  ë³µêµ¬ ì™„ë£Œ
ğŸ”„ ì£¼ë¬¸ ì·¨ì†Œ ì¤‘...
âœ… ì£¼ë¬¸ ì·¨ì†Œ ì™„ë£Œ
=== ë³´ìƒ íŠ¸ëœì­ì…˜ ì™„ë£Œ ===
```

**ì¥ì :**
- âœ… ì „ì²´ íë¦„ì´ ëª…í™•í•¨ (í•œ ê³³ì—ì„œ ê´€ë¦¬)
- âœ… ë””ë²„ê¹… ì‰¬ì›€
- âœ… ë³´ìƒ ë¡œì§ ì¤‘ì•™ ê´€ë¦¬
- âœ… ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬ ìš©ì´

**ë‹¨ì :**
- âŒ Orchestratorê°€ ë‹¨ì¼ ì¥ì• ì 
- âŒ Orchestratorì— ë¡œì§ ì§‘ì¤‘ (ê²°í•©ë„ ì¦ê°€)
- âŒ Orchestratorê°€ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆìŒ`
