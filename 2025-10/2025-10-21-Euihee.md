# Video Serving Architecture

## 주제 선정 이유
동영상 콘텐츠를 사용자가 업로드하고 시청할 수 있도록 안정적이고 효율적으로 **서빙(Streaming)** 하는 방법을  
멘토링을 통해 학습하고 정리함.

---

## 1. 업로드 및 서빙 방식 개요

### 업로드 방식
1. **단일 파일 업로드**
    - Presigned URL을 이용해 S3에 단일 MP4 파일로 업로드한다.
    - 업로드 후 별도 인코딩 없이 바로 S3 URL로 접근 가능하다.
    - 예시:
      ```
      https://{bucket}.s3.{region}.amazonaws.com/{video}.mp4
      ```

2. **세그먼트 단위 업로드 (인코딩 기반)**
    - ffmpeg 등 인코딩 도구를 통해 원본 동영상을 **세그먼트 단위(ts 파일)** 로 분할하고,
      인덱스 파일(m3u8)과 함께 업로드한다.
    - 이 방식을 사용하면 **HLS 스트리밍 방식**으로 서빙 가능하다.

---

### 서빙 방식 비교

| 구분 | S3 통파일 다운로드 방식 | HLS 스트리밍 방식 |
|------|------------------|----------------|
| 동작 방식 | 브라우저가 Range Request로 부분 다운로드 수행 | 플레이어가 m3u8 인덱스 기반으로 세그먼트 파일(ts)을 순차적으로 요청 |
| 스트리밍 서버 | 필요 없음 (S3 URL 직접 호출) | 필요 (HLS 인코딩 및 인덱스 생성) |
| CloudFront 캐시 | ❌ Range Request 기반이라 캐시 효과 거의 없음 | ✅ 세그먼트 단위 캐시 가능 (비용 절감 효과 큼) |
| 비용 효율 | 낮음 (다운로드 트래픽 증가) | 높음 (CDN 캐시로 트래픽 감소) |
| 확장성 | 낮음 | 매우 높음 |
| 초기 난이도 | 매우 낮음 | 인코딩 파이프라인 구축 필요 (ffmpeg / AWS MediaConvert 등) |

---

## 2. HLS(HTTP Live Streaming) 이란?

HLS는 **Apple**에서 개발한 **HTTP 기반 스트리밍 프로토콜**로,  
동영상을 일정 길이의 **세그먼트(segment)** 로 분할하고,  
**m3u8 인덱스 파일**을 통해 각 조각을 순차적으로 재생하는 구조이다.

### 장점
- HTTP 기반이라 별도 전용 스트리밍 프로토콜(RTMP 등) 없이도 동작.
- 세그먼트 단위 캐시가 가능하여 CDN 비용 절감.
- **Adaptive Bitrate Streaming(ABR)** 지원 → 네트워크 상황에 따라 화질 자동 조정.
- Safari, Chrome, Android 등 대부분의 브라우저 및 OS 지원.

### 단점
- 인코딩/세그먼트 생성 과정이 필요하여 초기 구현 난이도가 있음.
- 세그먼트가 짧을수록 요청 수가 많아져 서버 부하 증가 가능.



## 3. AWS MediaConvert 파이프라인 예시

1. 사용자가 S3에 원본 MP4 업로드
2. EventBridge → MediaConvert Job 트리거
3. MediaConvert가 m3u8 + ts 파일 세트를 S3에 업로드
4. CloudFront 배포를 통해 HLS 스트리밍 제공

---

## 4. ffmpeg / AWS MediaConvert 기반 HLS의 다운로드 가능 여부

### 🎯 결론 요약

| 구분 | 가능 여부 | 설명 |
|------|------------|------|
| **MP4 (단일 파일)** | ✅ 가능 | Range Request 기반으로 브라우저가 부분 다운로드하여 재생 가능 |
| **HLS (m3u8 + ts 세그먼트)** | ❌ 불가능 | 세그먼트 단위 스트리밍 전송을 전제로 설계된 프로토콜로, “다운로드 전체 재생” 구조와 다름 |

---

### 🔍 이유 상세 설명

#### 1. MP4 다운로드 방식
MP4 파일은 단일 파일이기 때문에, 브라우저나 플레이어가 Range Request로 **파일의 특정 바이트 범위만 요청**하며 재생할 수 있다.

- `Range: bytes=0-102400` 형태로 필요한 구간만 다운로드
- 전체 파일 다운로드 가능
- CDN 캐시 효율은 낮지만 구조 단순

➡️ 즉, **S3 + Range Request 방식은 “다운로드 중심 구조”**이다.

#### 2. HLS(Hypertext Live Streaming) 구조
HLS는 아래처럼 **세그먼트(ts)** 와 **인덱스(m3u8)** 로 구성된다.
- 클라이언트는 `m3u8` 파일을 열고 내부의 `.ts` 세그먼트를 순차적으로 요청한다.
- 각 ts는 2~10초 단위로 잘린 **작은 조각(Chunk)** 이다.
- 전체를 한 번에 다운로드하려면 모든 ts를 모아야 하지만, 이는 HLS의 목적과 다르다.

➡️ 따라서 **HLS는 다운로드 방식과 호환되지 않는다.**





### 요약

> ffmpeg 또는 AWS MediaConvert를 사용해 HLS로 인코딩된 동영상은 **다운로드 방식으로 제공할 수 없다.**  
> HLS는 **세그먼트 단위 HTTP 스트리밍 프로토콜**이기 때문에,  
> 다운로드 구조를 원한다면 HLS가 아닌 **단일 MP4 출력 포맷을 선택**해야 한다.  
> 즉, “다운로드”와 “HLS 스트리밍”은 상호 배타적인 구조이다.